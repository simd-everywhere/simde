name: CI

on:
  push:
    branches-ignore:
      - 'ci/**'
      - '!ci/gha**'
      - 'dependabot/**'
  pull_request:
    branches:
      - 'master'

concurrency:
  group: build-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:

  linux-gcc-loongarch64:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
    - name: CPU Information
      run: cat /proc/cpuinfo
    - name: Install APT Dependencies
      run: |
        sudo apt-get install -y pipx ninja-build ninja-build meson qemu-user-static
    - name: Download and install loongarch64-toolchain
      run: |
        wget https://github.com/loongson/build-tools/releases/download/2024.08.08/x86_64-cross-tools-loongarch64-binutils_2.43-gcc_14.2.0-glibc_2.40.tar.xz
        tar -xf x86_64-cross-tools-loongarch64-binutils_2.43-gcc_14.2.0-glibc_2.40.tar.xz -C /opt
    - name: ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}-binutils_2.43-gcc_14.2.0-glibc_2.40
    - name: set env
      run: |
        echo "LD_LIBRARY_PATH=/opt/cross-tools/target/usr/lib64:/opt/cross-tools/loongarch64-unknown-linux-gnu/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "PATH=$GITHUB_WORKSPACE:/opt/cross-tools/bin:$PATH" >> $GITHUB_ENV
    # - name: Disable SVML tests
    #   run: |
    #     sed -i "/svml/d" test/x86/meson.build
    #     rm test/x86/svml.c
    #     echo "Due to the qemu versions 7.2 through 8.0 causing timeouts in four sets of test cases,"
    #     echo "the SVML tests have been temporarily disabled."
    # - name: Disable RND*X tests
    #   run: |
    #     sed -i "/rndx/d" meson.build
    #     sed -i "/rnd..x/d" meson.build
    #     rm test/arm/neon/rndx.c test/arm/neon/rnd32x.c test/arm/neon/rnd64x.c
    #     echo "Due to the qemu versions 7.2 through 8.0 causing timeouts in four sets of test cases,"
    #     echo "the RNDX, RND32X, and RND64X tests have been temporarily disabled."
    - name: Configure
      run: meson setup build --cross-file=docker/cross-files/loongarch64-gcc-13-ccache.cross || (cat build/meson-logs/meson-log.txt ; false)
    - name: Build
      run: meson compile -C build -v
    - name: Test
      run: meson test -C build --print-errorlogs
