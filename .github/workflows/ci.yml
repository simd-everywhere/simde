name: CI

on:
  push:
    branches-ignore:
      - 'ci/**'
      - '!ci/gha**'
      - 'dependabot/**'
  pull_request:
    branches:
      - 'master'

concurrency:
  group: build-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:

  linux-gcc-loongarch64:
    runs-on: ubuntu-24.04
    container: amd64/ubuntu:24.10
    steps:
    - uses: actions/checkout@v4
    - name: CPU Information
      run: cat /proc/cpuinfo
    - name: Install APT Dependencies
      run: |
        apt-get update && apt-get install -y --no-install-recommends \
          ninja-build ninja-build meson qemu-user-static binfmt-support \
          libc6-loong64-cross libstdc++-14-dev-loong64-cross \
          gcc-14-loongarch64-linux-gnu g++-14-loongarch64-linux-gnu
    - name: ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ github.job }}
    # - name: Disable SVML tests
    #   run: |
    #     sed -i "/svml/d" test/x86/meson.build
    #     rm test/x86/svml.c
    #     echo "Due to the qemu versions 7.2 through 8.0 causing timeouts in four sets of test cases,"
    #     echo "the SVML tests have been temporarily disabled."
    # - name: Disable RND*X tests
    #   run: |
    #     sed -i "/rndx/d" meson.build
    #     sed -i "/rnd..x/d" meson.build
    #     rm test/arm/neon/rndx.c test/arm/neon/rnd32x.c test/arm/neon/rnd64x.c
    #     echo "Due to the qemu versions 7.2 through 8.0 causing timeouts in four sets of test cases,"
    #     echo "the RNDX, RND32X, and RND64X tests have been temporarily disabled."
    - name: Configure
      run: meson setup build --cross-file=docker/cross-files/loongarch64-gcc-14-ccache.cross || (cat build/meson-logs/meson-log.txt ; false)
    - name: Build
      run: meson compile -C build -v
    - name: Test
      run: meson test -C build --print-errorlogs
